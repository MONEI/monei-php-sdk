<?php

/**
 * ApplePayCertificateApiTest
 * PHP version 8.1
 *
 * @category Class
 * @package  Monei
 * @author   OpenAPI Generator team
 * @link     https://openapi-generator.tech
 */

/**
 * MONEI API v1
 *
 * The MONEI API is organized around REST principles.
 *
 * The version of the OpenAPI document: 1.8.0
 * Generated by: https://openapi-generator.tech
 * Generator version: 7.14.0
 */

namespace Monei\Test\Api;

use Monei\Configuration;
use Monei\ApiException;
use Monei\Api\ApplePayCertificateApi;
use Monei\Internal\GuzzleHttp\Client;
use Monei\Internal\GuzzleHttp\Handler\MockHandler;
use Monei\Internal\GuzzleHttp\HandlerStack;
use Monei\Internal\GuzzleHttp\Psr7\Response;
use Monei\Internal\GuzzleHttp\Middleware;
use PHPUnit\Framework\TestCase;

/**
 * ApplePayCertificateApiTest Class Doc Comment
 *
 * @category Class
 * @package  Monei
 * @author   OpenAPI Generator team
 * @link     https://openapi-generator.tech
 */
class ApplePayCertificateApiTest extends TestCase
{
    /**
     * API instance
     *
     * @var ApplePayCertificateApi
     */
    protected $api;

    /**
     * Mock handler for HTTP responses
     *
     * @var MockHandler
     */
    protected $mockHandler;

    /**
     * History container for requests
     *
     * @var array
     */
    protected $container = [];

    /**
     * Setup before running any test cases
     *
     * @return void
     */
    public static function setUpBeforeClass(): void
    {
    }

    /**
     * Setup before running each test case
     *
     * @return void
     */
    public function setUp(): void
    {
        $this->mockHandler = new MockHandler();
        $handlerStack = HandlerStack::create($this->mockHandler);
        $history = Middleware::history($this->container);
        $handlerStack->push($history);
        $client = new Client(['handler' => $handlerStack]);

        $config = Configuration::getDefaultConfiguration();
        $config->setApiKey('Authorization', 'test_api_key');

        $this->api = new ApplePayCertificateApi($client, $config);
    }

    /**
     * Clean up after running each test case
     *
     * @return void
     */
    public function tearDown(): void
    {
        $this->mockHandler->reset();
        $this->container = [];
    }

    /**
     * Clean up after running all test cases
     *
     * @return void
     */
    public static function tearDownAfterClass(): void
    {
    }

    /**
     * Test case for create
     *
     * Create Certificate.
     *
     * @return void
     */
    public function testCreate()
    {
        $this->mockHandler->append(
            new Response(
                200,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'id' => 'cert_123456789',
                        'accountId' => 'acc_123',
                        'csr' => 'base64_csr_data',
                        'active' => false,
                        'createdAt' => '2024-01-01T00:00:00Z'
                    ]
                )
            )
        );

        $result = $this->api->create();

        $this->assertCount(1, $this->container);
        $request = $this->container[0]['request'];
        $this->assertEquals('POST', $request->getMethod());
        $this->assertStringContainsString(
            '/apple-pay/certificates',
            $request->getUri()->getPath()
        );
        $this->assertStringNotContainsString(
            '/activate',
            $request->getUri()->getPath()
        );

        $this->assertEquals('cert_123456789', $result->getId());
        $this->assertEquals('acc_123', $result->getAccountId());
        $this->assertEquals('base64_csr_data', $result->getCsr());
        $this->assertFalse($result->getActive());
    }

    /**
     * Test case for callList
     *
     * List Certificates.
     *
     * @return void
     */
    public function testCallList()
    {
        $this->mockHandler->append(
            new Response(
                200,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        [
                            'id' => 'cert_123456789',
                            'accountId' => 'acc_123',
                            'active' => true,
                            'createdAt' => '2024-01-01T00:00:00Z'
                        ],
                        [
                            'id' => 'cert_987654321',
                            'accountId' => 'acc_123',
                            'active' => false,
                            'createdAt' => '2024-02-01T00:00:00Z'
                        ]
                    ]
                )
            )
        );

        $result = $this->api->callList();

        $this->assertCount(1, $this->container);
        $request = $this->container[0]['request'];
        $this->assertEquals('GET', $request->getMethod());
        $this->assertStringContainsString(
            '/apple-pay/certificates',
            $request->getUri()->getPath()
        );

        $this->assertCount(2, $result);
        $this->assertEquals('cert_123456789', $result[0]->getId());
        $this->assertTrue($result[0]->getActive());
        $this->assertEquals('cert_987654321', $result[1]->getId());
        $this->assertFalse($result[1]->getActive());
    }

    /**
     * Test case for get
     *
     * Get Certificate.
     *
     * @return void
     */
    public function testGet()
    {
        $certId = 'cert_123456789';

        $this->mockHandler->append(
            new Response(
                200,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'id' => $certId,
                        'accountId' => 'acc_123',
                        'cert' => 'base64_cert_data',
                        'active' => true,
                        'expireAt' => '2025-01-01T00:00:00Z',
                        'createdAt' => '2024-01-01T00:00:00Z'
                    ]
                )
            )
        );

        $result = $this->api->get($certId);

        $this->assertCount(1, $this->container);
        $request = $this->container[0]['request'];
        $this->assertEquals('GET', $request->getMethod());
        $this->assertStringContainsString(
            "/apple-pay/certificates/{$certId}",
            $request->getUri()->getPath()
        );

        $this->assertEquals($certId, $result->getId());
        $this->assertEquals('acc_123', $result->getAccountId());
        $this->assertTrue($result->getActive());
    }

    /**
     * Test case for activate
     *
     * Activate Certificate.
     *
     * @return void
     */
    public function testActivate()
    {
        $certId = 'cert_123456789';

        $this->mockHandler->append(
            new Response(
                200,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'id' => $certId,
                        'accountId' => 'acc_123',
                        'cert' => 'base64_cert_data',
                        'active' => true,
                        'expireAt' => '2025-01-01T00:00:00Z',
                        'createdAt' => '2024-01-01T00:00:00Z'
                    ]
                )
            )
        );

        $activateRequest = (object)['cert' => 'base64_signed_cert_from_apple'];

        $result = $this->api->activate($certId, $activateRequest);

        $this->assertCount(1, $this->container);
        $request = $this->container[0]['request'];
        $this->assertEquals('POST', $request->getMethod());
        $this->assertStringContainsString(
            "/apple-pay/certificates/{$certId}/activate",
            $request->getUri()->getPath()
        );

        $requestBody = json_decode($request->getBody()->getContents(), true);
        $this->assertEquals('base64_signed_cert_from_apple', $requestBody['cert']);

        $this->assertEquals($certId, $result->getId());
        $this->assertTrue($result->getActive());
    }

    /**
     * Test case for update
     *
     * Update Certificate.
     *
     * @return void
     */
    public function testUpdate()
    {
        $certId = 'cert_123456789';

        $this->mockHandler->append(
            new Response(
                200,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'id' => $certId,
                        'accountId' => 'acc_123',
                        'cert' => 'base64_cert_data',
                        'active' => false,
                        'expireAt' => '2025-01-01T00:00:00Z',
                        'createdAt' => '2024-01-01T00:00:00Z'
                    ]
                )
            )
        );

        $updateRequest = (object)['active' => false];

        $result = $this->api->update($certId, $updateRequest);

        $this->assertCount(1, $this->container);
        $request = $this->container[0]['request'];
        $this->assertEquals('POST', $request->getMethod());
        $this->assertStringContainsString(
            "/apple-pay/certificates/{$certId}",
            $request->getUri()->getPath()
        );
        $this->assertStringNotContainsString(
            '/activate',
            $request->getUri()->getPath()
        );

        $requestBody = json_decode($request->getBody()->getContents(), true);
        $this->assertFalse($requestBody['active']);

        $this->assertEquals($certId, $result->getId());
        $this->assertFalse($result->getActive());
    }

    /**
     * Test case for delete
     *
     * Delete Certificate.
     *
     * @return void
     */
    public function testDelete()
    {
        $certId = 'cert_123456789';

        $this->mockHandler->append(
            new Response(
                200,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'success' => true
                    ]
                )
            )
        );

        $result = $this->api->delete($certId);

        $this->assertCount(1, $this->container);
        $request = $this->container[0]['request'];
        $this->assertEquals('DELETE', $request->getMethod());
        $this->assertStringContainsString(
            "/apple-pay/certificates/{$certId}",
            $request->getUri()->getPath()
        );

        $this->assertTrue($result->getSuccess());
    }

    /**
     * Test case for get with missing id throws exception
     *
     * @return void
     */
    public function testGetWithMissingIdThrowsException()
    {
        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage(
            'Missing the required parameter $id when calling get'
        );

        $this->api->get(null);
    }

    /**
     * Test case for delete with missing id throws exception
     *
     * @return void
     */
    public function testDeleteWithMissingIdThrowsException()
    {
        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage(
            'Missing the required parameter $id when calling delete'
        );

        $this->api->delete(null);
    }

    /**
     * Test case for activate with missing id throws exception
     *
     * @return void
     */
    public function testActivateWithMissingIdThrowsException()
    {
        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage(
            'Missing the required parameter $id when calling activate'
        );

        $this->api->activate(null, (object)['cert' => 'test']);
    }

    /**
     * Test case for activate with missing request throws exception
     *
     * @return void
     */
    public function testActivateWithMissingRequestThrowsException()
    {
        $this->expectException(\InvalidArgumentException::class);

        $this->api->activate('cert_123', null);
    }

    /**
     * Test case for update with missing id throws exception
     *
     * @return void
     */
    public function testUpdateWithMissingIdThrowsException()
    {
        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage(
            'Missing the required parameter $id when calling update'
        );

        $this->api->update(null, (object)['active' => true]);
    }

    /**
     * Test case for update with missing request throws exception
     *
     * @return void
     */
    public function testUpdateWithMissingRequestThrowsException()
    {
        $this->expectException(\InvalidArgumentException::class);

        $this->api->update('cert_123', null);
    }

    /**
     * Test case for 404 error handling
     *
     * @return void
     */
    public function testGetNotFoundError()
    {
        $certId = 'cert_nonexistent';

        $this->mockHandler->append(
            new Response(
                404,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'statusCode' => 404,
                        'error' => 'Not Found',
                        'message' => 'Certificate not found'
                    ]
                )
            )
        );

        try {
            $this->api->get($certId);
            $this->fail('Expected ApiException was not thrown');
        } catch (ApiException $e) {
            $this->assertEquals(404, $e->getCode());
            $responseBody = json_decode($e->getResponseBody(), true);
            $this->assertEquals('Not Found', $responseBody['error']);
        }
    }

    /**
     * Test case for 401 unauthorized error
     *
     * @return void
     */
    public function testUnauthorizedError()
    {
        $this->mockHandler->append(
            new Response(
                401,
                ['Content-Type' => 'application/json'],
                json_encode(
                    [
                        'statusCode' => 401,
                        'error' => 'Unauthorized',
                        'message' => 'Invalid API key'
                    ]
                )
            )
        );

        try {
            $this->api->callList();
            $this->fail('Expected ApiException was not thrown');
        } catch (ApiException $e) {
            $this->assertEquals(401, $e->getCode());
            $responseBody = json_decode($e->getResponseBody(), true);
            $this->assertEquals('Unauthorized', $responseBody['error']);
        }
    }
}
